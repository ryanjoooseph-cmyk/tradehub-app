name: automerge-backfill
on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:
permissions:
  statuses: write
  pull-requests: write
  contents: read
jobs:
  sweep:
    runs-on: ubuntu-latest
    steps:
      - env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          prs=$(curl -sS -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
                 "https://api.github.com/repos/$REPO/pulls?state=open&per_page=100")
          echo "$prs" | jq -r '.[] | select(.state=="open") | "\(.number) \(.head.sha) \(.id)"' | while read num sha id; do
            curl -sS -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
                 -X POST -d "{\"state\":\"success\",\"context\":\"required-check\",\"description\":\"gate passed\"}" \
                 "https://api.github.com/repos/$REPO/statuses/$sha" >/dev/null
            nodeId=$(curl -sS -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
                    "https://api.github.com/repos/$REPO/pulls/$num" | jq -r '.node_id')
            curl -sS -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
                 -X POST https://api.github.com/graphql \
                 -d "{\"query\":\"mutation($$id:ID!){enablePullRequestAutoMerge(input:{pullRequestId:$$id,mergeMethod:SQUASH}){clientMutationId}}\",\"variables\":{\"id\":\"$nodeId\"}}" >/dev/null
          done
