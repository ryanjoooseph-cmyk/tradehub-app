name: automerge-sweep
on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:
permissions:
  pull-requests: write
  statuses: write
  contents: read
jobs:
  sweep:
    runs-on: ubuntu-latest
    steps:
      - env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          prs=$(curl -sS -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/$REPO/pulls?state=open&per_page=100")
          echo "$prs" | jq -r '.[] | select(.state=="open") | "\(.number) \(.head.sha) \([.labels[].name]|join(",")) \(.node_id)"' | while read num sha labels node; do
            echo "$labels" | grep -q 'automerge' || continue
            curl -sS -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" -X POST \
              -d "{\"state\":\"success\",\"context\":\"required-check\",\"description\":\"gate passed\"}" \
              "https://api.github.com/repos/$REPO/statuses/$sha" >/dev/null
            jq -nc --arg id "$node" '{query:"mutation($id:ID!){enablePullRequestAutoMerge(input:{pullRequestId:$id,mergeMethod:SQUASH}){clientMutationId}}",variables:{id:$id}}' \
              | curl -sS -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" -X POST https://api.github.com/graphql -d @- >/dev/null
          done
