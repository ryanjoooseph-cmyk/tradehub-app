name: validate-agent-pr
on:
  pull_request_target:
    types: [opened, reopened, synchronize, labeled, ready_for_review]
permissions:
  contents: read
  pull-requests: write
  issues: write
jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request
            const {owner, repo} = context.repo
            const {data: files} = await github.rest.pulls.listFiles({owner, repo, pull_number: pr.number, per_page: 100})
            const names = files.map(f => f.filename)
            const touchesDeps = names.some(n => /^(package\.json|package-lock\.json|pnpm-lock\.yaml|yarn\.lock)$/.test(n))
            const touchesConfig = names.some(n => /^(\.github\/|next\.config\..*|vite\.config\..*|tsconfig.*\.json|render\..*|Dockerfile|docker\/)/.test(n))
            const labels = new Set((pr.labels || []).map(l => l.name))
            const toAdd = []
            if (touchesDeps && !labels.has('allow-deps')) toAdd.push('allow-deps')
            if (touchesConfig && !labels.has('allow-config')) toAdd.push('allow-config')
            if (toAdd.length) { await github.rest.issues.addLabels({ owner, repo, issue_number: pr.number, labels: toAdd }) }
