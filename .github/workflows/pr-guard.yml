name: pr-guard
on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
permissions:
  contents: read
  pull-requests: write
jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const labels = new Set(pr.labels.map(l => l.name));
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              { owner, repo, pull_number: pr.number },
              res => res.data.map(f => f.filename)
            );
            let blocked = false;
            for (const f of files) {
              if (/^\.github\/workflows\//.test(f) && !labels.has('allow-config')) blocked = true;
              if (/(^|\/)(package\.json|pnpm-lock\.yaml|yarn\.lock|package-lock\.json)$/.test(f) && !labels.has('allow-deps')) blocked = true;
            }
            if (blocked) core.setFailed('guard');
