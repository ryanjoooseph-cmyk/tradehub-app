# .github/workflows/refresh-labeled-prs.yml
name: refresh-labeled-prs
on:
  schedule:
    - cron: "17 * * * *"   # hourly nudge
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  nudge:
    runs-on: ubuntu-latest
    steps:
      - name: Re-run safe-automerge on labeled PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/pulls \
            --paginate -q '.[] | select((.state=="open") and (.labels | any(.name=="automerge"))) | .number' |
          while read pr; do
            echo "Nudging PR #$pr"
            gh run list --json databaseId,headBranch -q \
              '.[] | select(.headBranch | contains("#'"$pr"'") or .headBranch=="")' >/dev/null || true
            gh workflow run safe-automerge.yml -f pr=$pr || true
          done
