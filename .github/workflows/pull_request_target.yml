name: merge-when-green
on:
  pull_request_target:
    types: [labeled, synchronize, opened, reopened]
permissions:
  contents: write
  pull-requests: write

jobs:
  guard:
    if: contains(github.event.pull_request.labels.*.name, 'automerge')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0, ref: ${{ github.event.pull_request.head.sha }} }
      - name: Allow only app/** changes
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1
          DIFF=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...${{ github.event.pull_request.head.sha }})
          echo "$DIFF" | awk '{print}' # log
          disallowed=$(echo "$DIFF" | grep -vE '^app/' || true)
          if [ -n "$disallowed" ]; then
            echo "Found changes outside app/:"
            echo "$disallowed"
            exit 1
          fi

  build:
    needs: guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { ref: ${{ github.event.pull_request.head.sha }} }
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - run: npm install
      - run: npm run build

  enable-automerge:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash
