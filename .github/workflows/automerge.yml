name: automerge
on:
  pull_request_target:
    types: [labeled, opened, synchronize, reopened, ready_for_review]
  check_suite:
    types: [completed]
permissions:
  contents: read
  pull-requests: write
jobs:
  enable:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner
            const repo = context.repo.repo
            async function targets() {
              if (context.payload.pull_request) return [context.payload.pull_request.number]
              const prs = await github.paginate(github.rest.pulls.list, { owner, repo, state: 'open', per_page: 100 })
              return prs.filter(p => p.labels.some(l=>l.name==='automerge')).map(p=>p.number)
            }
            for (const number of await targets()) {
              const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number: number })
              if (!pr.labels.some(l=>l.name==='automerge')) continue
              try {
                await github.graphql('mutation($id:ID!){ enablePullRequestAutoMerge(input:{pullRequestId:$id, mergeMethod:SQUASH}){ clientMutationId }}',{ id: pr.node_id })
              } catch {}
            }
