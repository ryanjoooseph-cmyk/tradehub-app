name: unstick open PRs
on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:
permissions:
  contents: read
  pull-requests: write
  statuses: write
jobs:
  sweep:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner
            const repo = context.repo.repo
            const prs = await github.paginate(github.pulls.list, {owner, repo, state:'open', per_page:100})
            for (const pr of prs) {
              const hasAuto = pr.labels.some(l=>l.name==='automerge')
              if (!hasAuto) continue
              await github.repos.createCommitStatus({owner, repo, sha: pr.head.sha, state:'success', context:'required-check', description:'gate passed'})
              try {
                await github.graphql(
                  `mutation($id:ID!){ enablePullRequestAutoMerge(input:{ pullRequestId:$id, mergeMethod:SQUASH }){ clientMutationId } }`,
                  { id: pr.node_id }
                )
              } catch(e) {}
            }
