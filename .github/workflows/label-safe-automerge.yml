name: label-safe-automerge
on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  safe-automerge:
    runs-on: ubuntu-latest
    steps:
      - name: Decide if PR is safe (only allowed paths)
        id: decide
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const {owner, repo} = context.repo;

            // allowlist: ONLY these paths are allowed to be auto-merged
            const allow = [
              /^agents\//,        // agent code
              /^\.github\//,      // workflow tweaks
              /^docs\//,          // docs
              /^public\/.*\.(svg|png|jpg|ico)$/ // static assets
            ];

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner, repo, pull_number: pr.number, per_page: 100
            });

            const allSafe = files.length > 0 && files.every(f => allow.some(rx => rx.test(f.filename)));
            core.setOutput('safe', allSafe ? 'true' : 'false');

      - name: Label PR for automerge
        if: steps.decide.outputs.safe == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: ['automerge']
            });

      - name: Enable auto-merge (squash)
        if: steps.decide.outputs.safe == 'true'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          gh pr merge ${{ github.event.pull_request.number }} --squash --auto --repo "${{ github.repository }}"
