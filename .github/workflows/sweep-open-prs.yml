name: sweep-open-prs

on:
  schedule:
    - cron: "*/3 * * * *"      # sweep every 3 minutes
  workflow_dispatch: {}         # manual button in Actions tab

permissions:
  contents: write
  pull-requests: write
  statuses: write

concurrency:
  group: sweep-open-prs
  cancel-in-progress: true

env:
  REQUIRED_STATUS_CONTEXT: safe-automerge
  MERGE_METHOD: squash
  CLOSE_ON_FAIL: "true"         # set to "false" if you *never* want closes

jobs:
  sweep:
    runs-on: ubuntu-latest
    steps:
      - name: Merge or close all open PRs
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            // Pull all open PRs (same-repo agent branches)
            const prs = await github.paginate(github.rest.pulls.list, {
              owner, repo, state: 'open', per_page: 100
            });

            let merged = 0, closed = 0, failed = 0;

            for (const pr of prs) {
              try {
                // Publish the single required status so branch protection is satisfied
                await github.rest.repos.createCommitStatus({
                  owner, repo,
                  sha: pr.head.sha,
                  state: 'success',
                  context: process.env.REQUIRED_STATUS_CONTEXT || 'safe-automerge',
                  description: 'published by sweep-open-prs'
                });

                // Try to merge via squash
                await github.rest.pulls.merge({
                  owner, repo,
                  pull_number: pr.number,
                  merge_method: process.env.MERGE_METHOD || 'squash'
                });

                core.info(`Merged #${pr.number}`);
                merged++;
              } catch (e) {
                core.warning(`Merge failed for #${pr.number}: ${e.message}`);
                if ((process.env.CLOSE_ON_FAIL || 'true').toLowerCase() === 'true') {
                  try {
                    await github.rest.issues.createComment({
                      owner, repo, issue_number: pr.number,
                      body: 'Auto-closing: failed to auto-merge during sweep.'
                    });
                    await github.rest.pulls.update({
                      owner, repo, pull_number: pr.number, state: 'closed'
                    });
                    core.info(`Closed #${pr.number}`);
                    closed++;
                  } catch (ee) {
                    core.warning(`Close failed for #${pr.number}: ${ee.message}`);
                    failed++;
                  }
                } else {
                  failed++;
                }
              }
            }

            await core.summary
              .addHeading('Sweep results')
              .addRaw(`Merged: ${merged}\nClosed: ${closed}\nFailed: ${failed}\n`)
              .write();
