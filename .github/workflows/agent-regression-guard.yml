name: Agent - Regression Guard

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'web/src/app/**'
      - 'web/src/components/**'
      - 'web/src/styles/**'

jobs:
  regression-guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get changed files
        id: changed-files
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            
            let allFiles = [];
            let page = 1;
            let hasMore = true;
            
            while (hasMore && page <= 10) {
              const { data: files } = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                per_page: 100,
                page,
              });
              
              allFiles = allFiles.concat(files.map(f => f.filename));
              hasMore = files.length === 100;
              page++;
            }
            
            // Filter to only UI-related files
            const uiFiles = allFiles.filter(f => 
              f.startsWith('web/src/app/') || 
              f.startsWith('web/src/components/') || 
              f.startsWith('web/src/styles/')
            );
            
            console.log(`Found ${uiFiles.length} UI-related files out of ${allFiles.length} total`);
            core.setOutput('files', JSON.stringify(uiFiles));
            core.setOutput('has_ui_changes', uiFiles.length > 0 ? 'true' : 'false');

      - name: Call Regression Guard Agent
        id: agent
        if: steps.changed-files.outputs.has_ui_changes == 'true'
        run: |
          CHANGED_FILES='${{ steps.changed-files.outputs.files }}'
          
          RESPONSE=$(curl -s -X POST "${{ secrets.AGENT_ENDPOINT_URL }}/api/agent/regression-guard" \
            -H "Content-Type: application/json" \
            -H "x-agent-secret: ${{ secrets.AGENT_SECRET }}" \
            -d "{
              \"prUrl\": \"${{ github.event.pull_request.html_url }}\",
              \"sha\": \"${{ github.event.pull_request.head.sha }}\",
              \"repo\": \"${{ github.repository }}\",
              \"changedFiles\": ${CHANGED_FILES}
            }" || echo '{"ok":false,"error":"curl failed"}')
          
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          echo "$RESPONSE" | jq . || echo "$RESPONSE"
          
          # Always exit 0 to not fail the workflow
          exit 0

      - name: Post PR Comment
        if: steps.changed-files.outputs.has_ui_changes == 'true'
        uses: actions/github-script@v7
        env:
          AGENT_RESPONSE: ${{ steps.agent.outputs.response }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const responseStr = process.env.AGENT_RESPONSE || '';
              if (!responseStr) {
                console.log('No response from agent');
                return;
              }

              const response = JSON.parse(responseStr);
              
              if (!response || !response.ok) {
                console.log('Agent call failed or returned error:', response);
                return;
              }

              const { changedRoutes, risk, checklist, notes } = response;
              
              const riskEmoji = risk === 'LOW' ? 'ðŸŸ¢' : risk === 'MEDIUM' ? 'ðŸŸ¡' : 'ðŸ”´';
              const marker = '<!-- AGENT_REGRESSION_GUARD -->';
              
              let comment = `${marker}\n## ðŸ›¡ï¸ Regression Guard Analysis\n\n`;
              comment += `**Risk Level:** ${riskEmoji} ${risk}\n\n`;
              
              if (changedRoutes.length > 0) {
                comment += `### ðŸ“ Changed Routes (${changedRoutes.length})\n`;
                changedRoutes.forEach(route => comment += `- ${route}\n`);
                comment += `\n`;
              }
              
              if (checklist.length > 0) {
                comment += `### âœ… Regression Checklist\n`;
                checklist.forEach(item => comment += `- [ ] ${item}\n`);
                comment += `\n`;
              }
              
              if (notes.length > 0) {
                comment += `### ðŸ“ Notes\n`;
                notes.forEach(note => comment += `${note}\n\n`);
              }
              
              comment += `---\n*Automated UI regression analysis. No Playwright tests yet - manual verification required.*`;

              // Check if a previous Regression Guard comment exists
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const existingComment = comments.find(c => c.body && c.body.includes(marker));

              if (existingComment) {
                console.log(`Updating existing comment ${existingComment.id}`);
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: comment
                });
              } else {
                console.log('Creating new comment');
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: comment
                });
              }
            } catch (error) {
              console.error('Failed to post/update comment:', error);
              // Don't fail the workflow
            }
