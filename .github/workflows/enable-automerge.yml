name: enable-automerge

on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review, labeled]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to enable auto-merge (manual)"
        required: false
        type: string

permissions:
  contents: read
  pull-requests: write

jobs:
  enable:
    runs-on: ubuntu-latest
    steps:
      - name: Enable auto-merge (best effort, never fail)
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const ev = context.eventName;
            const isPR = ev === 'pull_request_target';
            const pr = isPR ? context.payload.pull_request : null;
            const prNumber = pr?.number || (core.getInput('pr_number') ? Number(core.getInput('pr_number')) : null);

            if (!prNumber) {
              core.warning('No PR number available; skipping.');
              return;
            }
            if (isPR && pr?.draft) {
              core.info(`PR #${prNumber} is draft; skipping enable.`);
              return;
            }

            // Enable squash auto-merge via GraphQL. Never throw.
            try {
              const q = await github.graphql(
                `query($owner:String!, $repo:String!, $number:Int!) {
                  repository(owner:$owner, name:$repo) {
                    pullRequest(number:$number) { id }
                  }
                }`,
                { owner: context.repo.owner, repo: context.repo.repo, number: prNumber }
              );

              const prId = q?.repository?.pullRequest?.id;
              if (!prId) {
                core.warning(`Could not resolve PR id for #${prNumber}; skipping.`);
                return;
              }

              await github.graphql(
                `mutation($pullRequestId:ID!, $mergeMethod:PullRequestMergeMethod!) {
                  enablePullRequestAutoMerge(input:{ pullRequestId:$pullRequestId, mergeMethod:$mergeMethod }) {
                    pullRequest { number }
                  }
                }`,
                { pullRequestId: prId, mergeMethod: "SQUASH" }
              );

              core.info(`Enabled auto-merge (squash) for PR #${prNumber}`);
            } catch (e) {
              core.warning(`Enable auto-merge failed (non-blocking): ${e?.message || e}`);
            }
