name: pr-panic-brake
on:
  pull_request_target:
    types: [opened, reopened]

permissions:
  pull-requests: write

jobs:
  brake:
    runs-on: ubuntu-latest
    steps:
      - name: Close agent PRs if repo is flooded
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;

            // Only apply to in-repo agent PRs
            if (pr.head.repo.full_name !== `${owner}/${repo}`) return;
            if (!pr.head.ref.startsWith('agent-')) return;

            // Count open PRs (cap to 1000 for safety)
            const prs = await github.paginate(github.rest.pulls.list, {
              owner, repo, state: 'open', per_page: 100
            }, (res) => res.data);

            const openCount = prs.length;
            core.info(`Open PRs: ${openCount}`);

            if (openCount > 50) {
              await github.rest.pulls.update({
                owner, repo, pull_number: pr.number, state: 'closed'
              });
              await github.rest.issues.createComment({
                owner, repo, issue_number: pr.number,
                body: `Auto-closed by PR panic brake. Repo has ${openCount} open PRs.`
              });
            }
