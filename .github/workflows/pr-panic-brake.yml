name: pr-panic-brake

on:
  workflow_run:
    workflows: ["agent-ci", "required-check"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write

jobs:
  brake:
    runs-on: ubuntu-latest
    steps:
      - name: Disable auto-merge on failure
        if: ${{ github.event.workflow_run.conclusion != 'success' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PRS: ${{ toJson(github.event.workflow_run.pull_requests) }}
        run: |
          echo "$PRS" | jq -r '.[].number' | while read -r pr; do
            echo "Disabling auto-merge for PR #$pr due to failed workflow_run: ${{ github.event.workflow_run.name }}"
            gh pr merge "$pr" --repo "$REPO" --disable-auto || true
            gh pr edit "$pr" --repo "$REPO" --add-label "ci-failed" || true
          done
