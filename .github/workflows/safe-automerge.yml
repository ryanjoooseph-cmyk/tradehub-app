name: safe-automerge
on:
  pull_request_target:
    types: [opened, labeled, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  statuses: write

jobs:
  guard:
    name: guard
    runs-on: ubuntu-latest
    steps:
      - name: Check for automerge label
        id: chk
        run: |
          set -e
          has_label="$(jq -r '.pull_request.labels[].name' < "$GITHUB_EVENT_PATH" | grep -x 'automerge' || true)"
          if [ -n "$has_label" ]; then
            echo "eligible=true" >> "$GITHUB_OUTPUT"
          else
            echo "eligible=false" >> "$GITHUB_OUTPUT"
            echo "PR missing 'automerge' label" 1>&2
          fi

      # Publish a single required context named "safe-automerge"
      - name: Publish required status
        if: always()
        run: |
          sha="${{ github.event.pull_request.head.sha }}"
          state="failure"
          if [ "${{ steps.chk.outputs.eligible }}" = "true" ]; then state="success"; fi
          gh api repos/${{ github.repository }}/statuses/$sha \
            -f state="$state" -f context="safe-automerge" -f description="label gate"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  merge:
    name: merge
    needs: guard
    if: needs.guard.outputs.eligible == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Squash-merge the PR
        run: gh pr merge ${{ github.event.pull_request.number }} --squash --auto
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
