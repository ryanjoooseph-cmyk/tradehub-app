name: safe-automerge
on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled, unlabeled, ready_for_review]
permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Has 'automerge' label?
        id: label
        uses: actions-ecosystem/action-has-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: automerge

      - name: Diff files and detect risky paths
        id: diff
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const pr = context.payload.pull_request.number;
            const {data: files} = await github.pulls.listFiles({owner, repo, pull_number: pr, per_page: 300});
            // anything under app/src/server/lib/components/config, lockfiles, workflows = risky
            const riskyPatterns = [
              '^app/', '^src/', '^server/', '^api/', '^lib/', '^components/',
              '^pages/', '^next\\.config', '^package(-lock)?\\.json$', '^pnpm-lock\\.yaml$', '^yarn\\.lock$',
              '^\\.github/workflows/'
            ];
            const risky = files.some(f => riskyPatterns.some(p => new RegExp(p).test(f.filename)));
            core.setOutput('risky', risky ? 'true' : 'false');

      - name: Publish required status (safe-automerge)
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const sha = context.payload.pull_request.head.sha;
            const hasLabel = '${{ steps.label.outputs.hasLabels }}' === 'true';
            const risky = '${{ steps.diff.outputs.risky }}' === 'true';
            const eligible = hasLabel && !risky;
            await github.repos.createCommitStatus({
              owner, repo, sha,
              state: eligible ? 'success' : 'failure',
              context: 'safe-automerge',
              description: eligible ? 'Eligible (docs/agents-only + automerge label)' :
                                      'Not eligible (risky paths or missing label)'
            });
            core.setOutput('eligible', eligible ? 'true' : 'false');

      - name: Enable native auto-merge (squash)
        if: steps.label.outputs.hasLabels == 'true' && steps.diff.outputs.risky == 'false'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          merge-method: squash
