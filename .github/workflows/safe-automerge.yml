name: safe-automerge

on:
  pull_request_target:
    types: [opened, labeled, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write
  statuses: write

concurrency:
  group: automerge-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  guard:
    runs-on: ubuntu-latest
    outputs:
      eligible: ${{ steps.check.outputs.eligible }}
      reason:   ${{ steps.check.outputs.reason }}
    steps:
      - id: check
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // 1) require label
            const hasLabel = pr.labels.some(l => l.name === 'automerge');

            // 2) allow ONLY agents/**/plan.md changes (docs-only gate)
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              pull_number: pr.number,
              per_page: 300
            });
            const risky = files.some(f => !/^agents\/[^/]+\/plan\.md$/.test(f.filename));

            // 3) no drafts
            const eligible = hasLabel && !risky && !pr.draft;
            const reason = !hasLabel ? 'missing label' : risky ? 'risky paths' : pr.draft ? 'draft' : 'ok';

            core.setOutput('eligible', String(eligible));
            core.setOutput('reason', reason);
            core.summary.addRaw(`eligible=${eligible} | reason=${reason}`).write();

  publish-required-status:
    needs: guard
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Publish required commit status "safe-automerge"
        uses: actions/github-script@v7
        with:
          script: |
            const ok = "${{ needs.guard.outputs.eligible }}" === "true";
            const reason = "${{ needs.guard.outputs.reason }}";
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              sha:   context.payload.pull_request.head.sha,
              state: ok ? 'success' : 'failure',
              context: 'safe-automerge',
              description: ok ? 'eligible (docs+label)' : `not eligible (${reason})`
            });

  merge:
    needs: [guard, publish-required-status]
    if: needs.guard.outputs.eligible == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Squash-merge the PR
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              pull_number: context.payload.pull_request.number,
              merge_method: 'squash'
            });
