name: safe-automerge
on:
  pull_request_target:
    types: [opened, labeled, synchronize, reopened]
permissions:
  contents: read
  pull-requests: write

jobs:
  guard:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Ensure 'automerge' label exists
        id: lbl
        run: |
          HAS=false
          for L in ${{ join(github.event.pull_request.labels.*.name, ' ') }}; do
            [ "$L" = "automerge" ] && HAS=true
          done
          echo "has=$HAS" >> $GITHUB_OUTPUT
      - name: Fail if label missing
        if: steps.lbl.outputs.has != 'true'
        run: |
          echo "PR missing 'automerge' label."; exit 1

      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: List changed files
        id: ch
        uses: tj-actions/changed-files@v45
        with:
          since_last_remote_commit: true

      - name: Allow only docs/agents plan files
        run: |
          BAD=0
          for f in ${{ steps.ch.outputs.all_changed_files }}; do
            case "$f" in
              agents/*/plan.md|agents/**/plan.md|**/*.md) ;;
              *) echo "‚ùå risky path: $f"; BAD=1 ;;
            esac
          done
          [ $BAD -eq 0 ] || exit 1
