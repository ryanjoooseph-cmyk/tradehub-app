name: safe-automerge
on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled, ready_for_review]

permissions:
  contents: read
  pull-requests: read

jobs:
  safe-automerge:
    name: safe-automerge
    runs-on: ubuntu-latest
    steps:
      - name: Check changed files are scoped to agents/**/plan.md
        id: scope
        uses: actions/github-script@v7
        with:
          script: |
            const number = context.payload.pull_request.number;
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              { owner: context.repo.owner, repo: context.repo.repo, pull_number: number }
            );
            const ok = files.every(f =>
              f.filename.startsWith('agents/') && f.filename.endsWith('/plan.md')
            );
            if (!ok) {
              core.setFailed(
                'PR touches files outside allowed scope (agents/**/plan.md).'
              );
            }
            return ok;
