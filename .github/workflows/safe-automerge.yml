name: safe-automerge
on:
  pull_request_target:
    types: [opened, reopened, synchronize, labeled, ready_for_review]
permissions:
  contents: write
  pull-requests: write

jobs:
  guard:
    name: guard
    runs-on: ubuntu-latest
    steps:
      - name: Require "automerge" label
        id: label
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.pull_request.labels || []).map(l => l.name);
            core.setOutput('has', labels.includes('automerge') ? 'true' : 'false');

      - name: Path filters (allowed vs risky)
        id: paths
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            allowed:
              - 'agents/**'
              - 'app/**'
              - 'public/**'
              - '**/*.md'
              - '.github/**'
              - 'CODEOWNERS'
              - 'next.config.*'
              - 'tsconfig*.json'
              - 'package.json'
              - 'pnpm-lock.yaml'
            risky:
              - 'app/api/**'
              - 'lib/**'
              - 'server/**'
              - 'prisma/**'
              - 'supabase/**'
              - 'pages/api/**'

      - name: Fail if not eligible (no skip)
        if: ${{ ! (steps.label.outputs.has == 'true' && steps.paths.outputs.allowed == 'true' && steps.paths.outputs.risky != 'true') }}
        run: |
          echo "::error::Not eligible for auto-merge (need 'automerge' label and only safe paths)."
          exit 1

      - name: Eligible
        if: ${{ steps.label.outputs.has == 'true' && steps.paths.outputs.allowed == 'true' && steps.paths.outputs.risky != 'true' }}
        run: echo "Eligible âœ”"
