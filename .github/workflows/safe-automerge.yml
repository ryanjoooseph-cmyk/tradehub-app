name: safe-automerge

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled, unlabeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  guard:
    runs-on: ubuntu-latest

    steps:
      # (optional) keep your path filter / risky checks here

      - name: Ensure `automerge` label is actually present (live read)
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              issue_number: pr.number,
            });
            const names = labels.map(l => l.name.toLowerCase());
            core.info('Labels: ' + names.join(', '));
            if (!names.includes('automerge')) {
              core.setFailed("missing 'automerge' label");
            }
