name: safe-automerge
on:
  pull_request_target:
    types: [opened, reopened, synchronize, labeled, unlabeled]

permissions:
  contents: read
  pull-requests: write

jobs:
  guard:
    name: safe-automerge
    runs-on: ubuntu-latest
    steps:
      - name: Require 'automerge' label
        if: ${{ !contains(github.event.pull_request.labels.*.name, 'automerge') }}
        run: echo "PR missing 'automerge' label." && exit 1

      - name: List files in the PR
        id: files
        uses: actions/github-script@v7
        with:
          script: |
            const res = await github.paginate(
              github.rest.pulls.listFiles,
              { owner: context.repo.owner, repo: context.repo.repo,
                pull_number: context.payload.pull_request.number, per_page: 100 }
            );
            core.setOutput('list', res.map(f => f.filename).join('\n'));

      - name: Fail if any file is outside allowlist
        run: |
          echo "${{ steps.files.outputs.list }}" | tee changed.txt
          if grep -Evq '^(agents\/[^\/]+\/plan\.md|docs\/|.*\.md)$' changed.txt; then
            echo "PR touches risky paths. Leave for manual review."
            echo "Changed files:"; cat changed.txt
            exit 1
          fi

      - run: echo "Eligible for auto-merge."
