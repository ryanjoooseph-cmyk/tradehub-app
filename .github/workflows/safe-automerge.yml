      - name: Squash-merge when eligible (best effort)
        if: steps.gate.outputs.result == 'true'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          PR_NUMBER=${{ github.event.pull_request.number }}

          # Try GitHub's Auto-merge (needs repo setting enabled)
          gh pr merge "$PR_NUMBER" --squash --auto \
          || {
            # If auto-merge isnâ€™t enabled, enable it via GraphQL
            PR_ID=$(gh pr view "$PR_NUMBER" --json id -q .id)
            gh api graphql -f query='
              mutation($pr:ID!){
                enablePullRequestAutoMerge(input:{ pullRequestId:$pr, mergeMethod:SQUASH }) { clientMutationId }
              }' -f pr="$PR_ID" \
          ;} \
          || {
            # As a fallback, try an immediate squash merge (will succeed only if all reqs are green)
            gh pr merge "$PR_NUMBER" --squash --merge
          }
