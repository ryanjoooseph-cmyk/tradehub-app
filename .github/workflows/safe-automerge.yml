name: safe-automerge

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: read
  pull-requests: write
  checks: read
  statuses: read

jobs:
  guard:
    runs-on: ubuntu-latest

    steps:
      - name: Ensure 'automerge' label exists
        id: has_label
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.pull_request.labels || []).map(l => l.name);
            if (!labels.includes('automerge')) {
              core.setFailed("missing 'automerge' label");
            }

      - name: List changed files
        id: files
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const pr = context.payload.pull_request.number;
            const files = await github.paginate(github.rest.pulls.listFiles, { owner, repo, pull_number: pr });
            core.setOutput('files', JSON.stringify(files.map(f => f.filename)));

      - name: Enforce safe paths (docs only)
        uses: actions/github-script@v7
        with:
          script: |
            const files = JSON.parse(core.getInput('files', { required: true }));
            const isSafe = files.every(f =>
              (f.startsWith('agents/') || f.startsWith('docs/')) && /\.(md|mdx|txt)$/i.test(f)
            );
            if (!isSafe) {
              core.setFailed("touches risky paths (code/config/lockfiles) — manual review required");
            } else {
              core.info("PR is docs-only under agents/** or docs/** — eligible for automerge.");
            }
