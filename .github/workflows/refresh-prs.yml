name: refresh
on:
  schedule:
    - cron: '*/5 * * * *'
  push:
    branches: [main]
permissions:
  contents: write
  pull-requests: write
jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prs = await github.paginate(github.rest.pulls.list, { owner, repo, state: 'open', sort: 'created', direction: 'asc' });
            for (const pr of prs) {
              await github.rest.pulls.updateBranch({ owner, repo, pull_number: pr.number }).catch(() => {});
              const labels = pr.labels.map(l => l.name);
              if (!labels.includes('automerge')) continue;
              const full = await github.rest.pulls.get({ owner, repo, pull_number: pr.number });
              if (full.data.mergeable_state === 'clean') {
                await github.graphql(
                  'mutation($id:ID!){ enablePullRequestAutoMerge(input:{pullRequestId:$id, mergeMethod:SQUASH}){ clientMutationId } }',
                  { id: full.data.node_id }
                ).catch(() => {});
              }
            }
