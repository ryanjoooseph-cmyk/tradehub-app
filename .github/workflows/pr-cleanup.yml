name: pr-cleanup
on:
  schedule: [{ cron: "*/30 * * * *" }]
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: read

jobs:
  close-older-agent-dupes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const open = await github.paginate(github.rest.pulls.list, {owner, repo, state: 'open', per_page: 100});
            const groups = new Map();
            for (const pr of open.filter(p => p.title.startsWith('admin_disputes_frontend_') || p.title.startsWith('disputes_backend_'))) {
              const key = pr.title.replace(/\s+#\d+$/, '');
              const arr = groups.get(key) || [];
              arr.push(pr);
              groups.set(key, arr);
            }
            for (const [_, arr] of groups) {
              if (arr.length <= 1) continue;
              // keep newest, close older
              arr.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
              for (const pr of arr.slice(1)) {
                await github.rest.pulls.update({owner, repo, pull_number: pr.number, state: 'closed'});
              }
            }
