name: pr-cleanup
on:
  schedule:
    - cron: '0 * * * *'   # hourly
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  clean:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const {data: prs} = await github.pulls.list({ owner, repo, state: 'open', per_page: 100 });
            const agents = prs.filter(pr =>
              pr.labels?.some(l => l.name === 'automerge') && /^agent-/.test(pr.head.ref)
            );
            const groups = {};
            for (const pr of agents) {
              const m = pr.head.ref.match(/^(agent-[a-z0-9_]+)(?:-.+)?$/i);
              const key = m ? m[1] : pr.head.ref;
              (groups[key] ||= []).push(pr);
            }
            for (const [key, arr] of Object.entries(groups)) {
              arr.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
              for (const pr of arr.slice(1)) {
                await github.pulls.update({ owner, repo, pull_number: pr.number, state: 'closed' });
                console.log(`Closed stale PR #${pr.number} for ${key}`);
              }
            }
