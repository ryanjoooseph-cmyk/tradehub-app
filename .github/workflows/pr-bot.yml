name: pr-bot
on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled, unlabeled]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  label_guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo
            const pr = context.payload.pull_request
            if (!pr) return

            const repoLabels = await github.paginate(github.rest.issues.listLabelsForRepo, {owner, repo, per_page: 100})
            const have = new Set(repoLabels.map(l => l.name))
            const ensureLabel = async (name, color) => {
              if (!have.has(name)) {
                await github.rest.issues.createLabel({owner, repo, name, color: color || "2f81f7"})
                have.add(name)
              }
            }

            await ensureLabel('automerge', '0e8a16')
            await ensureLabel('allow-deps', 'fbca04')
            await ensureLabel('allow-config', 'fbca04')

            const files = await github.paginate(github.rest.pulls.listFiles, {owner, repo, pull_number: pr.number, per_page: 100})
            const touched = files.map(f => f.filename)

            const isOnlyDeps = touched.every(t => /(package\.json|pnpm-lock\.yaml|yarn\.lock|package-lock\.json)$/i.test(t))
            const isOnlyConfig = touched.every(t =>
              /(next\.config\.(mjs|js)|tsconfig\.json|\.eslintrc.*|\.prettier.*|\.github\/workflows\/.*)$/i.test(t)
            )
            const safeUI = touched.every(t =>
              /^(app\/|components\/|styles\/|lib\/)/.test(t)
            ) && !touched.some(t => /(package\.json|pnpm-lock\.yaml|yarn\.lock|package-lock\.json)$/i.test(t))

            const labels = (await github.rest.issues.listLabelsOnIssue({owner, repo, issue_number: pr.number})).data.map(l=>l.name)
            const add = async (name) => { if (!labels.includes(name)) await github.rest.issues.addLabels({owner, repo, issue_number: pr.number, labels:[name]}) }

            if (isOnlyDeps) await add('allow-deps')
            if (isOnlyConfig) await add('allow-config')
            if (safeUI || isOnlyDeps || isOnlyConfig) await add('automerge')

            const needsAllow = touched.some(t =>
              /(package\.json|pnpm-lock\.yaml|yarn\.lock|package-lock\.json|next\.config\.(mjs|js)|tsconfig\.json|\.github\/workflows\/.*)$/i.test(t)
            )
            const hasAllow = labels.includes('allow-deps') || labels.includes('allow-config') || isOnlyDeps || isOnlyConfig

            if (needsAllow && !hasAllow) {
              core.setFailed('guard: add allow-deps or allow-config')
              return
            }

  enable_and_refresh:
    needs: label_guard
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo
            const pr = context.payload.pull_request
            if (!pr) return

            const labels = (await github.rest.issues.listLabelsOnIssue({owner, repo, issue_number: pr.number})).data.map(l=>l.name)
            if (labels.includes('automerge')) {
              try {
                await github.graphql(
                  `mutation($id:ID!){ enablePullRequestAutoMerge(input:{pullRequestId:$id, mergeMethod:SQUASH}){ clientMutationId } }`,
                  { id: pr.node_id }
                )
              } catch {}
            }

            const refreshed = await github.rest.pulls.get({owner, repo, pull_number: pr.number})
            if (refreshed.data.mergeable_state === 'dirty' || refreshed.data.mergeable_state === 'blocked') {
              try {
                await github.request('PUT /repos/{owner}/{repo}/pulls/{pull_number}/update-branch', {owner, repo, pull_number: pr.number})
              } catch {}
            }

  bump_automerge_queue:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo
            const prs = await github.paginate(github.rest.pulls.list, {owner, repo, state: 'open', per_page: 100})
            for (const pr of prs) {
              const labels = (await github.rest.issues.listLabelsOnIssue({owner, repo, issue_number: pr.number})).data.map(l=>l.name)
              if (labels.includes('automerge')) {
                try {
                  await github.request('PUT /repos/{owner}/{repo}/pulls/{pull_number}/update-branch', {owner, repo, pull_number: pr.number})
                } catch {}
              }
            }
