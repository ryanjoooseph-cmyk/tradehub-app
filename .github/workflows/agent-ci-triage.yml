name: Agent - CI Triage

on:
  workflow_run:
    workflows: ["web-build"]
    types: [completed]

jobs:
  ci-triage:
    runs-on: ubuntu-latest
    steps:
      - name: Get PR info from workflow run
        id: pr-info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runId = context.payload.workflow_run.id;
            const headSha = context.payload.workflow_run.head_sha;
            const repo = context.payload.workflow_run.repository.full_name;
            const runUrl = context.payload.workflow_run.html_url;
            
            // Get PR associated with this workflow run
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
            });
            
            if (prs.length === 0) {
              console.log('No open PR found for this workflow run');
              core.setOutput('has_pr', 'false');
              return;
            }
            
            const pr = prs[0];
            console.log(`Found PR #${pr.number}: ${pr.html_url}`);
            
            core.setOutput('has_pr', 'true');
            core.setOutput('pr_number', pr.number.toString());
            core.setOutput('pr_url', pr.html_url);
            core.setOutput('head_sha', headSha);
            core.setOutput('repo', repo);
            core.setOutput('run_url', runUrl);

      - name: Get check-runs for head SHA
        id: check-runs
        if: steps.pr-info.outputs.has_pr == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const headSha = '${{ steps.pr-info.outputs.head_sha }}';
            
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: headSha,
            });

            const failedChecks = checkRuns.check_runs
              .filter(run => ['failure', 'cancelled', 'timed_out', 'action_required'].includes(run.conclusion))
              .map(run => ({
                name: run.name,
                conclusion: run.conclusion,
                detailsUrl: run.details_url,
              }));

            console.log(`Found ${failedChecks.length} failing checks`);
            core.setOutput('failed_checks', JSON.stringify(failedChecks));
            core.setOutput('has_failures', failedChecks.length > 0 ? 'true' : 'false');

      - name: Call CI Triage Agent
        id: agent
        if: steps.check-runs.outputs.has_failures == 'true'
        run: |
          FAILED_CHECKS='${{ steps.check-runs.outputs.failed_checks }}'
          
          RESPONSE=$(curl -s -X POST "${{ secrets.AGENT_ENDPOINT_URL }}/api/agent/ci-triage" \
            -H "Content-Type: application/json" \
            -H "x-agent-secret: ${{ secrets.AGENT_SECRET }}" \
            -d "{
              \"prUrl\": \"${{ steps.pr-info.outputs.pr_url }}\",
              \"sha\": \"${{ steps.pr-info.outputs.head_sha }}\",
              \"repo\": \"${{ steps.pr-info.outputs.repo }}\",
              \"runUrl\": \"${{ steps.pr-info.outputs.run_url }}\",
              \"failedChecks\": ${FAILED_CHECKS}
            }" || echo '{"ok":false,"error":"curl failed"}')
          
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          echo "$RESPONSE" | jq . || echo "$RESPONSE"
          
          # Always exit 0 to not fail the workflow
          exit 0

      - name: Update or Create PR Comment
        if: steps.check-runs.outputs.has_failures == 'true'
        uses: actions/github-script@v7
        env:
          AGENT_RESPONSE: ${{ steps.agent.outputs.response }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const responseStr = process.env.AGENT_RESPONSE || '';
              if (!responseStr) {
                console.log('No response from agent');
                return;
              }

              const response = JSON.parse(responseStr);
              
              if (!response || !response.ok) {
                console.log('Agent call failed or returned error:', response);
                return;
              }

              const { headline, classification, likelyCause, commands, nextActions, notes } = response;
              const prNumber = parseInt('${{ steps.pr-info.outputs.pr_number }}');
              
              const classEmoji = {
                'LINT': 'üîç',
                'TYPECHECK': 'üìò',
                'BUILD': 'üî®',
                'TEST': 'üß™',
                'DEPLOY': 'üöÄ',
                'UNKNOWN': '‚ùì'
              };
              
              const emoji = classEmoji[classification] || '‚ùì';
              const marker = '<!-- AGENT_CI_TRIAGE -->';
              
              let comment = `${marker}\n## ${emoji} CI Triage: ${headline}\n\n`;
              comment += `**Classification:** ${classification}\n\n`;
              comment += `### Likely Cause\n${likelyCause}\n\n`;
              
              if (commands && commands.length > 0) {
                comment += `### Commands to Run\n\`\`\`bash\n${commands.join('\n')}\n\`\`\`\n\n`;
              }
              
              if (nextActions && nextActions.length > 0) {
                comment += `### Next Actions\n`;
                nextActions.forEach(action => comment += `- ${action}\n`);
                comment += `\n`;
              }
              
              if (notes) {
                comment += `### Notes\n${notes}\n\n`;
              }
              
              comment += `---\n*Automated triage by CI Agent. Review logs for details.*`;

              // Check if a previous CI Triage comment exists
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
              });

              const existingComment = comments.find(c => c.body && c.body.includes(marker));

              if (existingComment) {
                console.log(`Updating existing comment ${existingComment.id}`);
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: comment
                });
              } else {
                console.log('Creating new comment');
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: comment
                });
              }
            } catch (error) {
              console.error('Failed to post/update comment:', error);
              // Don't fail the workflow
            }
