name: kick-open-automerge-prs
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"   # every 30 minutes
permissions:
  contents: write
  pull-requests: write
jobs:
  kick:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const label = 'automerge';
            const pulls = await github.paginate(
              github.rest.pulls.list,
              { owner: context.repo.owner, repo: context.repo.repo, state: 'open', per_page: 100 }
            );
            const targets = pulls.filter(pr => pr.labels.some(l => l.name === label));
            for (const pr of targets) {
              core.info(`Kicking #${pr.number} ${pr.title}`);
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner, repo: context.repo.repo,
                  issue_number: pr.number, name: label
                });
              } catch {}
              await github.rest.issues.addLabels({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: pr.number, labels: [label]
              });
            }
