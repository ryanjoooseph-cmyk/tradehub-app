name: Agent - Support Triage

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  support-triage:
    runs-on: ubuntu-latest
    steps:
      - name: Check if triage should run
        id: should-run
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const comment = context.payload.comment;

            const hasLabel = issue.labels && issue.labels.some(label =>
              label.name.toLowerCase() === 'support'
            );

            const hasCommand = comment && comment.body && comment.body.includes('/triage');

            const shouldRun = hasLabel || hasCommand;
            console.log(`Should run: ${shouldRun} (hasLabel: ${hasLabel}, hasCommand: ${hasCommand})`);

            core.setOutput('should_run', shouldRun ? 'true' : 'false');
            core.setOutput('issue_number', issue.number.toString());
            core.setOutput('issue_url', issue.html_url);
            core.setOutput('issue_title', issue.title);
            core.setOutput('issue_body', issue.body || '');
            core.setOutput('labels', JSON.stringify(issue.labels?.map(l => l.name) || []));
            core.setOutput('commenter', comment?.user?.login || '');
            core.setOutput('comment_body', comment?.body || '');

      - name: Call Support Triage Agent
        id: agent
        if: steps.should-run.outputs.should_run == 'true'
        run: |
          ISSUE_NUMBER='${{ steps.should-run.outputs.issue_number }}'
          ISSUE_URL='${{ steps.should-run.outputs.issue_url }}'
          ISSUE_TITLE='${{ steps.should-run.outputs.issue_title }}'
          ISSUE_BODY='${{ steps.should-run.outputs.issue_body }}'
          LABELS='${{ steps.should-run.outputs.labels }}'
          COMMENTER='${{ steps.should-run.outputs.commenter }}'
          COMMENT_BODY='${{ steps.should-run.outputs.comment_body }}'

          ISSUE_BODY_JSON=$(echo "$ISSUE_BODY" | jq -Rs .)
          ISSUE_TITLE_JSON=$(echo "$ISSUE_TITLE" | jq -Rs .)
          COMMENT_BODY_JSON=$(echo "$COMMENT_BODY" | jq -Rs .)
          COMMENTER_JSON=$(echo "$COMMENTER" | jq -Rs .)

          PAYLOAD=$(jq -n \
            --arg issueUrl "$ISSUE_URL" \
            --argjson issueNumber "$ISSUE_NUMBER" \
            --argjson title "$ISSUE_TITLE_JSON" \
            --argjson body "$ISSUE_BODY_JSON" \
            --argjson labels "$LABELS" \
            --argjson commenter "$COMMENTER_JSON" \
            --argjson commentBody "$COMMENT_BODY_JSON" \
            '{issueUrl:$issueUrl,issueNumber:$issueNumber,title:$title,body:$body,labels:$labels,commenter:$commenter,commentBody:$commentBody}')

          HTTP_CODE=$(curl -s -S -o /tmp/st_response.json -w "%{http_code}" -X POST "${{ secrets.AGENT_ENDPOINT_URL }}/api/agent/support-triage" \
            -H "Content-Type: application/json" \
            -H "x-agent-secret: ${{ secrets.AGENT_SECRET }}" \
            -d "$PAYLOAD" 2>/dev/null || echo "000")

          RESPONSE=$(cat /tmp/st_response.json 2>/dev/null || echo '{"ok":false,"error":"failed to read response"}')

          if [[ "$HTTP_CODE" != "200" ]]; then
            echo "Support Triage endpoint returned HTTP $HTTP_CODE"
            RESPONSE="{\"ok\":false,\"error\":\"support-triage endpoint unavailable (HTTP $HTTP_CODE)\",\"priority\":\"P2\",\"category\":\"OTHER\",\"summary\":\"Unable to triage\",\"nextActions\":[\"Manual review required\"],\"suggestedReply\":\"Thank you for your report. Our team will review this shortly.\"}"
          fi

          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "$RESPONSE" | jq . >/dev/null 2>&1 && echo "$RESPONSE" | jq . || echo "$RESPONSE"
          exit 0

      - name: Post Triage Comment
        if: steps.should-run.outputs.should_run == 'true'
        uses: actions/github-script@v7
        env:
          AGENT_RESPONSE: ${{ steps.agent.outputs.response }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const responseStr = process.env.AGENT_RESPONSE || '';
              if (!responseStr) return;

              const response = JSON.parse(responseStr);
              if (!response || !response.ok) return;

              const { priority, category, summary, nextActions, suggestedReply } = response;
              const issueNumber = parseInt('${{ steps.should-run.outputs.issue_number }}');

              const priorityEmoji = { P0:'ğŸ”´', P1:'ğŸŸ ', P2:'ğŸŸ¡', P3:'ğŸŸ¢' };
              const categoryEmoji = { BUG:'ğŸ›', UX:'ğŸ¨', BILLING:'ğŸ’°', ESCROW:'ğŸ”’', MARKETPLACE:'ğŸª', PERFORMANCE:'âš¡', OTHER:'ğŸ“' };

              const marker = '<!-- AGENT_SUPPORT_TRIAGE -->';

              let comment = `${marker}\n## ğŸ¯ Support Triage\n\n`;
              comment += `**Priority:** ${priorityEmoji[priority] || 'âšª'} ${priority}\n`;
              comment += `**Category:** ${categoryEmoji[category] || 'ğŸ“'} ${category}\n`;
              comment += `**Summary:** ${summary}\n\n`;

              if (nextActions && nextActions.length > 0) {
                comment += `### ğŸ“‹ Next Actions\n`;
                nextActions.forEach(a => comment += `- ${a}\n`);
                comment += `\n`;
              }

              if (suggestedReply) {
                comment += `### ğŸ’¬ Suggested Reply\n\n${suggestedReply}\n\n`;
              }

              comment += `---\n*Automated triage by Support Agent. Human review recommended.*`;

              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
              });

              const existing = comments.find(c => c.body && c.body.includes(marker));

              if (existing) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existing.id,
                  body: comment
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: comment
                });
              }
            } catch (e) {
              console.error(e);
            }
