import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  try {
    const input = await request.json();

    // Validate input structure minimally
    if (typeof input !== 'object' || input === null) {
      return NextResponse.json({ ok: false, error: 'Invalid input' }, { status: 400 });
    }

    // Normalize checks into array format
    let checks: Array<{ name: string; status: string }> = [];
    if (input.checks) {
      if (Array.isArray(input.checks)) {
        checks = input.checks
          .filter((c) => c && typeof c === 'object')
          .map((c) => ({ name: String((c as any).name || ''), status: String((c as any).status || '') }))
          .filter((c) => c.name.length > 0);
      } else if (typeof input.checks === 'object') {
        // Convert object format { lint: true, build: false } to array format
        checks = Object.entries(input.checks as Record<string, unknown>).map(([name, passed]) => ({
          name,
          status: passed === true ? 'success' : 'failure',
        }));
      }
    }

    // Analyze checks (STRICT):
    // - If we don't have any checks, we MUST NOT claim they passed.
    // - We only consider success if every check status is success.
    const hasChecks = checks.length > 0;
    const allChecksPassed = hasChecks && checks.every((c) => c.status === 'success');

    // Require the main CI check (web-build) to be present and successful to APPROVE.
    const webBuild = checks.find((c) => c.name.toLowerCase().includes('web-build'));
    const hasWebBuild = Boolean(webBuild);
    const webBuildPassed = webBuild?.status === 'success';

    // Risk assessment (dummy logic for example)
    const riskLevels = ['LOW', 'MED', 'HIGH'] as const;
    let risk: typeof riskLevels[number] = 'LOW';
    if (input.body && typeof input.body === 'string') {
      if (input.body.includes('TODO')) {
        risk = 'MED';
      }
      if (input.body.includes('FIXME')) {
        risk = 'HIGH';
      }
    }

    // Build checklist
    const checklist = { passed: [] as string[], missing: [] as string[] };

    if (!hasChecks) {
      checklist.missing.push('CI checks unknown (no completed checks found)');
    } else if (!allChecksPassed) {
      checklist.missing.push('CI checks failing');
    } else {
      checklist.passed.push('All CI checks passed');
    }

    if (!hasWebBuild) {
      checklist.missing.push('web-build check missing');
    } else if (!webBuildPassed) {
      checklist.missing.push('web-build failing');
    } else {
      checklist.passed.push('web-build passed');
    }

    // Recommendation logic
    const recommendation: 'APPROVE' | 'BLOCK' =
      allChecksPassed && webBuildPassed && risk !== 'HIGH' ? 'APPROVE' : 'BLOCK';

    // Compose changelog and notes (dummy)
    const changelog = input.changedFiles || [];
    const notes = `Risk level assessed as ${risk}`;

    return NextResponse.json({
      ok: true,
      recommendation,
      risk,
      checklist,
      notes,
      changelog,
    });
  } catch (error) {
    return NextResponse.json({ ok: false, error: (error as Error).message }, { status: 500 });
  }
}
