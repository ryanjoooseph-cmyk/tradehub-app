name: agent-release-manager

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to analyze (manual)"
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set PR_NUMBER
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> "$GITHUB_ENV"
          else
            echo "PR_NUMBER=${{ inputs.pr_number }}" >> "$GITHUB_ENV"
          fi

      - name: Call agent endpoint (best effort)
        env:
          AGENT_ENDPOINT_URL: ${{ secrets.AGENT_ENDPOINT_URL }}
          AGENT_SECRET: ${{ secrets.AGENT_SECRET }}
        run: |
          set -euo pipefail
          if [ -z "${AGENT_ENDPOINT_URL:-}" ] || [ -z "${AGENT_SECRET:-}" ]; then
            echo "Missing AGENT_ENDPOINT_URL or AGENT_SECRET; exiting 0 to avoid spam failures."
            exit 0
          fi
          payload=$(printf '{"prNumber":%s,"repo":"%s"}' "$PR_NUMBER" "${{ github.repository }}")
          curl -sS -X POST "${AGENT_ENDPOINT_URL%/}/api/agent/release-manager" \
            -H "content-type: application/json" \
            -H "x-agent-secret: ${AGENT_SECRET}" \
            --data "$payload" >/dev/null || true
