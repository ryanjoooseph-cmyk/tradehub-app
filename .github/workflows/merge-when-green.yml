name: merge-when-green
on:
  pull_request_target:
    types: [opened, reopened, synchronize, labeled, ready_for_review]
permissions:
  contents: write
  pull-requests: write

jobs:
  automerge:
    runs-on: ubuntu-latest
    steps:
      - name: Check label and changed paths
        id: elig
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request
            const labels = (pr.labels || []).map(l => l.name)
            const hasLabel = labels.includes('automerge')

            // List changed files (first 200 is fine for these PRs)
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              { owner: context.repo.owner, repo: context.repo.repo, pull_number: pr.number, per_page: 100 }
            )
            const paths = files.map(f => f.filename)

            const riskyGlobs = [
              'app/api/**','server/**','lib/**','src/**',
              '**/*.yml','**/*.yaml','**/package*.json','pnpm-lock.yaml','yarn.lock'
            ]
            const mm = require('micromatch')
            const isRisky = mm(paths, riskyGlobs).length > 0

            const safeGlobs = ['agents/**','**/*.md','.github/**']
            const isSafeOnly = mm.not(paths, riskyGlobs).length === paths.length
              && mm(paths, safeGlobs).length === paths.length

            core.setOutput('eligible', String(hasLabel && isSafeOnly && !isRisky))
            core.setOutput('hasLabel', String(hasLabel))
            core.setOutput('isRisky', String(isRisky))
            core.setOutput('paths', JSON.stringify(paths))

      - name: Log eligibility
        run: |
          echo "eligible=${{ steps.elig.outputs.eligible }}"
          echo "hasLabel=${{ steps.elig.outputs.hasLabel }}"
          echo "isRisky=${{ steps.elig.outputs.isRisky }}"
          echo "paths=${{ steps.elig.outputs.paths }}"

      - name: Enable PR automerge (squash)
        if: steps.elig.outputs.eligible == 'true'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash

      - name: Merge when green
        if: steps.elig.outputs.eligible == 'true'
        uses: peter-evans/merge-when-green@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Mark ineligible (no-op success)
        if: steps.elig.outputs.eligible != 'true'
        run: echo "PR not eligible (missing label or risky paths). Leaving open for manual review."
