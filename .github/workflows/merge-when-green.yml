name: merge-when-green

on:
  pull_request_target:
    types: [opened, reopened, synchronize, labeled, ready_for_review]

permissions:
  contents: write
  pull-requests: write
  statuses: read

jobs:
  automerge:
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    steps:
      - name: Merge when safe-automerge is green and label present
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const pr = context.payload.pull_request;

            // Must have label
            const has = (pr.labels || []).some(l => l.name === 'automerge');
            if (!has) { core.setFailed('Missing automerge label.'); return; }

            // safe-automerge status must be success
            const statuses = await github.rest.repos.getCombinedStatusForRef({
              owner, repo, ref: pr.head.sha
            });
            const ctx = statuses.data.statuses.find(s => s.context === 'safe-automerge');
            if (!ctx || ctx.state !== 'success') {
              core.setFailed('safe-automerge not green yet.'); return;
            }

            // Enable GitHub auto-merge (squash) â€“ succeeds when all branch rules are met
            const q = await github.graphql(`
              mutation($id:ID!){
                enablePullRequestAutoMerge(input:{pullRequestId:$id, mergeMethod:SQUASH}) {
                  clientMutationId
                }
              }`,
              { id: pr.node_id }
            );
            core.notice('Auto-merge enabled.');
