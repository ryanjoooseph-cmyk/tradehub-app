name: auto-update-and-merge
on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review, labeled]
concurrency:
  group: pr-${{ github.event.pull_request.number }}-${{ github.workflow }}
  cancel-in-progress: true
jobs:
  update-and-merge:
    if: startsWith(github.head_ref, 'agent-') && contains(github.event.pull_request.labels.*.name, 'automerge')
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    # Never block PRs - this is best-effort automation
    continue-on-error: true
    permissions:
      pull-requests: write
      contents: write
      issues: read
    steps:
      - name: Gatekeeper label check
        id: gate
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;

            const { data: issue } = await github.rest.issues.get({
              owner,
              repo,
              issue_number: prNumber,
            });

            const labels = (issue.labels || []).map(l => (l.name || '').toLowerCase());
            const hasRiskLow = labels.includes('risk-low');
            const blocked = labels.includes('needs-review') || labels.includes('risk-high') || labels.includes('risk-med');

            console.log('PR labels:', labels);
            console.log('hasRiskLow:', hasRiskLow, 'blocked:', blocked);

            core.setOutput('should_enable', String(hasRiskLow && !blocked));

      - name: Update branch + enable automerge (single PR; best-effort)
        if: steps.gate.outputs.should_enable == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            const number = pr.number;

            if (pr.draft) {
              await github.rest.pulls.update({ owner, repo, pull_number: number, draft: false });
            }

            const full = await github.rest.pulls.get({ owner, repo, pull_number: number });
            const state = full.data.mergeable_state;

            if (['dirty','behind','unstable','unknown'].includes(state)) {
              try { await github.rest.pulls.updateBranch({ owner, repo, pull_number: number }); } catch (e) {}
            }

            try {
              await github.graphql(
                'mutation($pr:ID!){ enablePullRequestAutoMerge(input:{pullRequestId:$pr, mergeMethod:SQUASH}){ clientMutationId } }',
                { pr: full.data.node_id }
              );
            } catch (e) {}

      - name: Skip auto-merge
        if: steps.gate.outputs.should_enable != 'true'
        run: echo "Auto-merge not enabled: requires label 'risk-low' and no 'needs-review'/'risk-high'/'risk-med'."
